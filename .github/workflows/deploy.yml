name: Deploy to Fly.io

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reset_config:
        description: "Reset config to default (deletes existing /data/openclaw.json)"
        required: false
        type: boolean
        default: false
      openclaw_version:
        description: "OpenClaw version (latest, main, tag, or commit SHA)"
        required: false
        type: string
        default: "latest"

jobs:
  deploy:
    name: Deploy OpenClaw app
    runs-on: ubuntu-latest
    concurrency: deploy-group # Ensure only one deployment at a time
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Validate required secrets
        run: |
          [ -n "${FLY_API_TOKEN}" ] || { echo "Missing required secret: FLY_API_TOKEN"; exit 1; }
          [ -n "${FLY_APP_NAME}" ] || { echo "Missing required secret: FLY_APP_NAME"; exit 1; }
          [ -n "${FLY_REGION}" ] || { echo "Missing required secret: FLY_REGION"; exit 1; }
          [ -n "${OPENCLAW_GATEWAY_TOKEN}" ] || { echo "Missing required secret: OPENCLAW_GATEWAY_TOKEN"; exit 1; }
          [ -n "${CLOUDFLARE_TUNNEL_TOKEN}" ] || { echo "Missing required secret: CLOUDFLARE_TUNNEL_TOKEN"; exit 1; }

          if [ -z "${ANTHROPIC_API_KEY}" ] && [ -z "${OPENAI_API_KEY}" ] && [ -z "${GOOGLE_API_KEY}" ]; then
            echo "Set at least one model provider key: ANTHROPIC_API_KEY, OPENAI_API_KEY, or GOOGLE_API_KEY"
            exit 1
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          FLY_REGION: ${{ secrets.FLY_REGION }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}

      - name: Render deploy fly.toml from secrets
        run: |
          cp fly.toml fly.generated.toml
          sed -i "s/^app = .*/app = \"${FLY_APP_NAME}\"/" fly.generated.toml
          sed -i "s/^primary_region = .*/primary_region = \"${FLY_REGION}\"/" fly.generated.toml
          sed -i "s/^  source = .*/  source = \"${FLY_VOLUME_NAME}\"/" fly.generated.toml
          echo "Rendered deploy config:"
          rg -n -e "^(app|primary_region) = " -e "^  source = " fly.generated.toml
        env:
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          FLY_REGION: ${{ secrets.FLY_REGION }}
          FLY_VOLUME_NAME: ${{ secrets.FLY_VOLUME_NAME || 'openclaw_data' }}

      - name: Ensure Fly app and volume exist
        run: |
          set -euo pipefail

          if flyctl apps show "${FLY_APP_NAME}" >/dev/null 2>&1; then
            echo "Fly app exists: ${FLY_APP_NAME}"
          else
            echo "Creating Fly app: ${FLY_APP_NAME}"
            if [ -n "${FLY_ORG}" ]; then
              flyctl apps create "${FLY_APP_NAME}" --org "${FLY_ORG}"
            else
              flyctl apps create "${FLY_APP_NAME}"
            fi
          fi

          if flyctl volumes list --app "${FLY_APP_NAME}" | rg -q "\\b${FLY_VOLUME_NAME}\\b"; then
            echo "Volume exists: ${FLY_VOLUME_NAME}"
          else
            echo "Creating volume ${FLY_VOLUME_NAME} in region ${FLY_REGION} (${FLY_VOLUME_SIZE_GB}GB)"
            flyctl volumes create "${FLY_VOLUME_NAME}" --app "${FLY_APP_NAME}" --region "${FLY_REGION}" --size "${FLY_VOLUME_SIZE_GB}"
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          FLY_REGION: ${{ secrets.FLY_REGION }}
          FLY_ORG: ${{ secrets.FLY_ORG }}
          FLY_VOLUME_NAME: ${{ secrets.FLY_VOLUME_NAME || 'openclaw_data' }}
          FLY_VOLUME_SIZE_GB: ${{ secrets.FLY_VOLUME_SIZE_GB || '1' }}

      - name: Set Fly.io secrets from GitHub secrets
        run: |
          set -euo pipefail

          SECRETS=(
            "OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}"
            "CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}"
          )
          [ -n "${ANTHROPIC_API_KEY}" ] && SECRETS+=("ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}")
          [ -n "${OPENAI_API_KEY}" ] && SECRETS+=("OPENAI_API_KEY=${OPENAI_API_KEY}")
          [ -n "${GOOGLE_API_KEY}" ] && SECRETS+=("GOOGLE_API_KEY=${GOOGLE_API_KEY}")
          [ -n "${DISCORD_BOT_TOKEN}" ] && SECRETS+=("DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}")
          [ -n "${DISCORD_GUILD_ID}" ] && SECRETS+=("DISCORD_GUILD_ID=${DISCORD_GUILD_ID}")
          [ -n "${OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH}" ] && SECRETS+=("OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH=${OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH}")
          flyctl secrets set "${SECRETS[@]}" --app "${FLY_APP_NAME}" --stage

          if [ -z "${OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH}" ]; then
            flyctl secrets unset OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH --app "${FLY_APP_NAME}" || true
          fi

          if [ "${RESET_CONFIG}" = "true" ]; then
            flyctl secrets set RESET_CONFIG=true --app "${FLY_APP_NAME}" --stage
          else
            flyctl secrets unset RESET_CONFIG --app "${FLY_APP_NAME}" || true
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH: ${{ secrets.OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH }}
          RESET_CONFIG: ${{ inputs.reset_config || 'false' }}

      - name: Deploy
        run: flyctl deploy --remote-only --config fly.generated.toml --app "${FLY_APP_NAME}" --build-arg OPENCLAW_VERSION="${OPENCLAW_VERSION}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          OPENCLAW_VERSION: ${{ inputs.openclaw_version || 'latest' }}
