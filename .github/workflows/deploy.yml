name: Deploy to Fly.io

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      reset_config:
        description: "Reset config to default (deletes existing /data/openclaw.json)"
        required: false
        type: boolean
        default: false
      openclaw_version:
        description: "OpenClaw version (main, tag, or commit SHA)"
        required: false
        type: string
        default: "main"

jobs:
  deploy:
    name: Deploy OpenClaw app
    runs-on: ubuntu-latest
    concurrency: deploy-group # Ensure only one deployment at a time
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@v1

      - name: Validate required secrets
        run: |
          set -euo pipefail

          [ -n "${FLY_API_TOKEN}" ] || { echo "Missing required secret: FLY_API_TOKEN"; exit 1; }
          [ -n "${FLY_APP_NAME}" ] || { echo "Missing required secret: FLY_APP_NAME"; exit 1; }
          [ -n "${OPENCLAW_GATEWAY_TOKEN}" ] || { echo "Missing required secret: OPENCLAW_GATEWAY_TOKEN"; exit 1; }
          [ -n "${CLOUDFLARE_TUNNEL_TOKEN}" ] || { echo "Missing required secret: CLOUDFLARE_TUNNEL_TOKEN"; exit 1; }

          if [ -z "${ANTHROPIC_API_KEY}" ] && [ -z "${OPENAI_API_KEY}" ] && [ -z "${GEMINI_API_KEY}" ]; then
            echo "Set at least one model provider key: ANTHROPIC_API_KEY, OPENAI_API_KEY, or GEMINI_API_KEY"
            exit 1
          fi

          case "${FLY_VOLUME_SIZE_GB}" in
            ''|*[!0-9]*)
              echo "FLY_VOLUME_SIZE_GB must be a positive integer (got: ${FLY_VOLUME_SIZE_GB})"
              exit 1
              ;;
          esac
          [ "${FLY_VOLUME_SIZE_GB}" -ge 1 ] || { echo "FLY_VOLUME_SIZE_GB must be >= 1"; exit 1; }
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          FLY_REGION: ${{ secrets.FLY_REGION || 'iad' }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          FLY_VOLUME_SIZE_GB: ${{ secrets.FLY_VOLUME_SIZE_GB || '1' }}

      - name: Ensure Fly app and volume exist
        run: |
          set -euo pipefail
          FLY_VOLUME_NAME="openclaw_data"

          if flyctl status --app "${FLY_APP_NAME}" >/dev/null 2>&1; then
            echo "Fly app exists: ${FLY_APP_NAME}"
          else
            echo "Creating Fly app: ${FLY_APP_NAME}"
            if [ -n "${FLY_ORG}" ]; then
              flyctl apps create "${FLY_APP_NAME}" --org "${FLY_ORG}"
            else
              flyctl apps create "${FLY_APP_NAME}"
            fi
          fi

          EXISTING_VOLUMES="$(flyctl volumes list --app "${FLY_APP_NAME}" | awk 'NR>1 {print $3}')"
          if printf "%s\n" "${EXISTING_VOLUMES}" | grep -Fxq -- "${FLY_VOLUME_NAME}"; then
            echo "Volume exists: ${FLY_VOLUME_NAME}"
          else
            echo "Creating volume ${FLY_VOLUME_NAME} in region ${FLY_REGION} (${FLY_VOLUME_SIZE_GB}GB)"
            flyctl volumes create "${FLY_VOLUME_NAME}" --app "${FLY_APP_NAME}" --region "${FLY_REGION}" --size "${FLY_VOLUME_SIZE_GB}" --yes
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          FLY_REGION: ${{ secrets.FLY_REGION || 'iad' }}
          FLY_ORG: ${{ secrets.FLY_ORG }}
          FLY_VOLUME_SIZE_GB: ${{ secrets.FLY_VOLUME_SIZE_GB || '1' }}

      - name: Log setup warnings and opportunities
        run: |
          set -euo pipefail

          if [ -n "${DISCORD_BOT_TOKEN}" ] && [ -z "${DISCORD_GUILD_ID}" ]; then
            echo "::warning title=Discord auto-wiring skipped::DISCORD_BOT_TOKEN is set but DISCORD_GUILD_ID is missing. Set both values to auto-configure Discord channels."
          fi

          if [ -z "${DISCORD_BOT_TOKEN}" ] && [ -n "${DISCORD_GUILD_ID}" ]; then
            echo "::warning title=Discord auto-wiring skipped::DISCORD_GUILD_ID is set but DISCORD_BOT_TOKEN is missing. Set both values to auto-configure Discord channels."
          fi

          if [ -n "${DISCORD_BOT_TOKEN}" ] && [ -n "${DISCORD_GUILD_ID}" ] && [ -z "${DISCORD_CHANNEL_ID}" ]; then
            echo "::notice title=Discord channel default::DISCORD_CHANNEL_ID is not set. Startup seeds 'general' while allowing all guild channels by default."
          fi

          if [ -n "${GEMINI_API_KEY}" ] && [ -z "${OPENAI_API_KEY}" ] && [ -z "${ANTHROPIC_API_KEY}" ]; then
            echo "::notice title=Model auto-selection::Only GEMINI_API_KEY is set. Startup will choose google/gemini-3-pro-preview as the primary model."
          fi
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

      - name: Set Fly.io secrets from GitHub secrets
        run: |
          set -euo pipefail

          SECRETS=(
            "OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN}"
            "CLOUDFLARE_TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}"
            "OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH=${OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH_EFFECTIVE}"
          )
          [ -n "${ANTHROPIC_API_KEY}" ] && SECRETS+=("ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}")
          [ -n "${OPENAI_API_KEY}" ] && SECRETS+=("OPENAI_API_KEY=${OPENAI_API_KEY}")
          [ -n "${GEMINI_API_KEY}" ] && SECRETS+=("GEMINI_API_KEY=${GEMINI_API_KEY}")
          [ -n "${DISCORD_BOT_TOKEN}" ] && SECRETS+=("DISCORD_BOT_TOKEN=${DISCORD_BOT_TOKEN}")
          [ -n "${DISCORD_GUILD_ID}" ] && SECRETS+=("DISCORD_GUILD_ID=${DISCORD_GUILD_ID}")
          [ -n "${DISCORD_CHANNEL_ID}" ] && SECRETS+=("DISCORD_CHANNEL_ID=${DISCORD_CHANNEL_ID}")
          flyctl secrets set "${SECRETS[@]}" --app "${FLY_APP_NAME}" --stage

          if [ "${RESET_CONFIG}" = "true" ]; then
            flyctl secrets set RESET_CONFIG=true --app "${FLY_APP_NAME}" --stage
          else
            flyctl secrets unset RESET_CONFIG --app "${FLY_APP_NAME}" --stage || true
          fi
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          OPENCLAW_GATEWAY_TOKEN: ${{ secrets.OPENCLAW_GATEWAY_TOKEN }}
          CLOUDFLARE_TUNNEL_TOKEN: ${{ secrets.CLOUDFLARE_TUNNEL_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_GUILD_ID: ${{ secrets.DISCORD_GUILD_ID }}
          DISCORD_CHANNEL_ID: ${{ secrets.DISCORD_CHANNEL_ID }}
          OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH_EFFECTIVE: ${{ secrets.OPENCLAW_CONTROL_UI_ALLOW_INSECURE_AUTH || 'false' }}
          RESET_CONFIG: ${{ inputs.reset_config || 'false' }}

      - id: fly_deploy
        name: Deploy
        run: flyctl deploy --remote-only --config fly.toml --app "${FLY_APP_NAME}" --build-arg OPENCLAW_VERSION="${OPENCLAW_VERSION}"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
          OPENCLAW_VERSION: ${{ inputs.openclaw_version || 'main' }}

      - name: Dump Fly diagnostics on deploy failure
        if: ${{ failure() && steps.fly_deploy.outcome == 'failure' }}
        run: |
          set +e
          echo "::group::Fly app status"
          flyctl status --app "${FLY_APP_NAME}"
          echo "::endgroup::"

          echo "::group::Fly machine list"
          flyctl machines list --app "${FLY_APP_NAME}"
          echo "::endgroup::"

          echo "::group::Fly logs"
          flyctl logs --app "${FLY_APP_NAME}" --no-tail
          echo "::endgroup::"
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}

      - name: Clear one-shot reset flag
        if: ${{ always() && inputs.reset_config == true }}
        run: flyctl secrets unset RESET_CONFIG --app "${FLY_APP_NAME}" || true
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          FLY_APP_NAME: ${{ secrets.FLY_APP_NAME }}
